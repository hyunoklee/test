[INFO] [1538884939.177397, 27.151000]: object num : 1.[0] -0.239 , -0.067 , 0.643 
[INFO] [1538884939.295884, 27.249000]: object num : 1.[0] -0.239 , -0.067 , 0.643 
[INFO] [1538884939.441848, 27.350000]: object num : 1.[0] -0.239 , -0.067 , 0.643 
[ INFO] [1538884939.468511335, 27.369000000]: computeCenterAndBoundingBox1
[ INFO] [1538884939.468584050, 27.369000000]: computeCenterAndBoundingBox7
[ INFO] [1538884939.468648267, 27.369000000]: computeCenterAndBoundingBox8
[INFO] [1538884939.576704, 27.449000]: object num : 1.[0] -0.239 , -0.067 , 0.643 
[INFO] [1538884939.714012, 27.549000]: object num : 1.[0] -0.239 , -0.067 , 0.643 
[ INFO] [1538884939.870656491, 27.649000000]: computeCenterAndBoundingBox1
[ INFO] [1538884939.870754014, 27.649000000]: computeCenterAndBoundingBox7
[ INFO] [1538884939.870809408, 27.649000000]: computeCenterAndBoundingBox8
[INFO] [1538884939.872491, 27.651000]: object num : 1.[0] -0.239 , -0.067 , 0.643 
[INFO] [1538884940.033076, 27.773000]: object num : 1.[0] -0.239 , -0.067 , 0.643 
[INFO] [1538884940.160177, 27.851000]: object num : 1.[0] -0.239 , -0.067 , 0.643 
[ INFO] [1538884940.218875978, 27.885000000]: computeCenterAndBoundingBox1
[ INFO] [1538884940.218923236, 27.885000000]: computeCenterAndBoundingBox7
[ INFO] [1538884940.218957075, 27.885000000]: computeCenterAndBoundingBox8
[INFO] [1538884940.303500, 27.949000]: object num : 1.[0] -0.239 , -0.067 , 0.643 
[INFO] [1538884940.456727, 28.049000]: object num : 1.[0] -0.239 , -0.067 , 0.643 
[ INFO] [1538884940.564240534, 28.120000000]: computeCenterAndBoundingBox1
[ INFO] [1538884940.564309127, 28.120000000]: computeCenterAndBoundingBox7
[ INFO] [1538884940.564365065, 28.120000000]: computeCenterAndBoundingBox8
[INFO] [1538884940.599309, 28.149000]: object num : 1.[0] -0.240 , -0.069 , 0.643 
[INFO] [1538884940.736323, 28.249000]: object num : 1.[0] -0.240 , -0.069 , 0.643 
[ INFO] [1538884940.897172291, 28.350000000]: computeCenterAndBoundingBox1
[INFO] [1538884940.897178, 28.350000]: object num : 1.[0] -0.240 , -0.069 , 0.643 
[ INFO] [1538884940.897240541, 28.350000000]: computeCenterAndBoundingBox7
[ INFO] [1538884940.897271547, 28.350000000]: computeCenterAndBoundingBox8



////////////////////////////////////////////////////////////////////////////


[ INFO] [1538884992.183845636, 64.885000000]: computeCenterAndBoundingBox1
[ INFO] [1538884992.184049079, 64.885000000]: computeCenterAndBoundingBox7
[ INFO] [1538884992.184176226, 64.885000000]: computeCenterAndBoundingBox8
[ INFO] [1538884992.184324007, 64.885000000]: computeCenterAndBoundingBox1
[ INFO] [1538884992.184424403, 64.885000000]: computeCenterAndBoundingBox7
[ INFO] [1538884992.184518179, 64.885000000]: computeCenterAndBoundingBox9
[ INFO] [1538884992.184687116, 64.885000000]: computeCenterAndBoundingBox1
[ INFO] [1538884992.184795515, 64.885000000]: computeCenterAndBoundingBox7
[ INFO] [1538884992.184900124, 64.885000000]: computeCenterAndBoundingBox8
[INFO] [1538884992.257732, 64.949000]: object num : 3.[0] 0.043 , -0.071 , 0.416 
[INFO] [1538884992.258138, 64.949000]: object num : 3
[INFO] [1538884992.258424, 64.949000]: object num : 3.[2] 0.053 , -0.103 , 0.413 
[INFO] [1538884992.407672, 65.050000]: object num : 3.[0] 0.043 , -0.071 , 0.416 
[INFO] [1538884992.408286, 65.051000]: object num : 3
[INFO] [1538884992.408607, 65.051000]: object num : 3.[2] 0.053 , -0.103 , 0.413 
[INFO] [1538884992.575806, 65.149000]: object num : 3.[0] 0.043 , -0.071 , 0.416 
[INFO] [1538884992.576227, 65.149000]: object num : 3
[INFO] [1538884992.576518, 65.149000]: object num : 3.[2] 0.053 , -0.103 , 0.413 
[INFO] [1538884992.717420, 65.250000]: object num : 3.[0] 0.043 , -0.071 , 0.416 
[INFO] [1538884992.717859, 65.250000]: object num : 3
[INFO] [1538884992.718179, 65.250000]: object num : 3.[2] 0.053 , -0.103 , 0.413 
[ INFO] [1538884992.739986604, 65.268000000]: computeCenterAndBoundingBox1
[ INFO] [1538884992.740174319, 65.268000000]: computeCenterAndBoundingBox7
[ INFO] [1538884992.740284425, 65.269000000]: computeCenterAndBoundingBox8
[ INFO] [1538884992.740429842, 65.269000000]: computeCenterAndBoundingBox1
[ INFO] [1538884992.740526402, 65.269000000]: computeCenterAndBoundingBox7
[ INFO] [1538884992.740617918, 65.269000000]: computeCenterAndBoundingBox8
[INFO] [1538884992.865393, 65.349000]: object num : 2.[0] 0.027 , -0.072 , 0.405 
[INFO] [1538884992.865827, 65.349000]: object num : 2.[1] 0.068 , -0.104 , 0.402 
[INFO] [1538884993.001541, 65.450000]: object num : 2.[0] 0.027 , -0.072 , 0.405 
[INFO] [1538884993.001926, 65.450000]: object num : 2.[1] 0.068 , -0.104 , 0.402 
[INFO] [1538884993.145830, 65.549000]: object num : 2.[0] 0.027 , -0.072 , 0.405 
[INFO] [1538884993.146444, 65.550000]: object num : 2.[1] 0.068 , -0.104 , 0.402 
[INFO] [1538884993.277813, 65.650000]: object num : 2.[0] 0.027 , -0.072 , 0.405 
[INFO] [1538884993.278446, 65.650000]: object num : 2.[1] 0.068 , -0.104 , 0.402 
[ INFO] [1538884993.291231325, 65.659000000]: computeCenterAndBoundingBox1
[ INFO] [1538884993.291299106, 65.659000000]: computeCenterAndBoundingBox7
[ INFO] [1538884993.291340080, 65.659000000]: computeCenterAndBoundingBox9
[ INFO] [1538884993.291557956, 65.659000000]: computeCenterAndBoundingBox1
[ INFO] [1538884993.291673240, 65.659000000]: computeCenterAndBoundingBox7
[ INFO] [1538884993.291777498, 65.659000000]: computeCenterAndBoundingBox9
[INFO] [1538884993.426711, 65.750000]: object num : 2
[INFO] [1538884993.427135, 65.750000]: object num : 2
[INFO] [1538884993.588630, 65.851000]: object num : 2
[INFO] [1538884993.589108, 65.851000]: object num : 2
[INFO] [1538884993.729620, 65.949000]: object num : 2
[INFO] [1538884993.730033, 65.949000]: object num : 2
[INFO] [1538884993.860707, 66.049000]: object num : 2
[INFO] [1538884993.861186, 66.049000]: object num : 2
[INFO] [1538884993.992590, 66.149000]: object num : 2
[INFO] [1538884993.993116, 66.150000]: object num : 2
[ INFO] [1538884994.122189210, 66.245000000]: computeCenterAndBoundingBox1
[ INFO] [1538884994.122235121, 66.245000000]: computeCenterAndBoundingBox7
[ INFO] [1538884994.122257075, 66.245000000]: computeCenterAndBoundingBox9
[ INFO] [1538884994.122486715, 66.245000000]: computeCenterAndBoundingBox1
[ INFO] [1538884994.122509723, 66.245000000]: computeCenterAndBoundingBox7
[ INFO] [1538884994.122540435, 66.245000000]: computeCenterAndBoundingBox9
[ INFO] [1538884994.122578012, 66.245000000]: computeCenterAndBoundingBox1
[ INFO] [1538884994.122597449, 66.245000000]: computeCenterAndBoundingBox7
[ INFO] [1538884994.122616262, 66.245000000]: computeCenterAndBoundingBox9
[ INFO] [1538884994.122708669, 66.245000000]: computeCenterAndBoundingBox1
[ INFO] [1538884994.122728172, 66.245000000]: computeCenterAndBoundingBox7
[ INFO] [1538884994.122747835, 66.245000000]: computeCenterAndBoundingBox9
[INFO] [1538884994.126669, 66.250000]: object num : 4
[INFO] [1538884994.127130, 66.250000]: object num : 4
[INFO] [1538884994.127499, 66.250000]: object num : 4
[INFO] [1538884994.127769, 66.250000]: object num : 4
[INFO] [1538884994.272344, 66.352000]: object num : 4
[INFO] [1538884994.272843, 66.352000]: object num : 4
[INFO] [1538884994.273161, 66.352000]: object num : 4
[INFO] [1538884994.273475, 66.352000]: object num : 4
[INFO] [1538884994.401964, 66.452000]: object num : 4
[INFO] [1538884994.402818, 66.453000]: object num : 4
[INFO] [1538884994.403368, 66.453000]: object num : 4
[INFO] [1538884994.403924, 66.454000]: object num : 4
[INFO] [1538884994.550228, 66.549000]: object num : 4
[INFO] [1538884994.550625, 66.549000]: object num : 4
[INFO] [1538884994.551286, 66.550000]: object num : 4
[INFO] [1538884994.551568, 66.550000]: object num : 4
[ INFO] [1538884994.646666528, 66.604000000]: computeCenterAndBoundingBox1
[ INFO] [1538884994.647108604, 66.604000000]: computeCenterAndBoundingBox7
[ INFO] [1538884994.647242731, 66.604000000]: computeCenterAndBoundingBox9
[ INFO] [1538884994.647501151, 66.604000000]: computeCenterAndBoundingBox1
[ INFO] [1538884994.647523288, 66.604000000]: computeCenterAndBoundingBox7
[ INFO] [1538884994.647556877, 66.604000000]: computeCenterAndBoundingBox9
[INFO] [1538884994.706076, 66.649000]: object num : 2
[INFO] [1538884994.706502, 66.649000]: object num : 2
[INFO] [1538884994.857298, 66.749000]: object num : 2
[INFO] [1538884994.857754, 66.749000]: object num : 2
[INFO] [1538884995.009922, 66.854000]: object num : 2
[INFO] [1538884995.010346, 66.854000]: object num : 2
[INFO] [1538884995.144229, 66.950000]: object num : 2
[INFO] [1538884995.144640, 66.950000]: object num : 2
[ INFO] [1538884995.158557394, 66.956000000]: computeCenterAndBoundingBox1
[ INFO] [1538884995.158594797, 66.956000000]: computeCenterAndBoundingBox7
[ INFO] [1538884995.158612828, 66.956000000]: computeCenterAndBoundingBox9
[ INFO] [1538884995.158860476, 66.956000000]: computeCenterAndBoundingBox1
[ INFO] [1538884995.158883303, 66.956000000]: computeCenterAndBoundingBox7
[ INFO] [1538884995.158917165, 66.956000000]: computeCenterAndBoundingBox9
[INFO] [1538884995.285097, 67.050000]: object num : 2
[INFO] [1538884995.288358, 67.052000]: object num : 2
[INFO] [1538884995.428673, 67.149000]: object num : 2
[INFO] [1538884995.429205, 67.149000]: object num : 2
[INFO] [1538884995.550986, 67.250000]: object num : 2
[INFO] [1538884995.551388, 67.250000]: object num : 2
[ INFO] [1538884995.662968256, 67.324000000]: computeCenterAndBoundingBox1
[ INFO] [1538884995.663034785, 67.324000000]: computeCenterAndBoundingBox7
[ INFO] [1538884995.663059572, 67.324000000]: computeCenterAndBoundingBox9
[ INFO] [1538884995.663263951, 67.324000000]: computeCenterAndBoundingBox1
[ INFO] [1538884995.663284527, 67.324000000]: computeCenterAndBoundingBox7
[ INFO] [1538884995.663313527, 67.324000000]: computeCenterAndBoundingBox9
[INFO] [1538884995.697013, 67.349000]: object num : 2
[INFO] [1538884995.697638, 67.349000]: object num : 2
[INFO] [1538884995.823001, 67.449000]: object num : 2
[INFO] [1538884995.823458, 67.449000]: object num : 2
[INFO] [1538884995.969659, 67.551000]: object num : 2
[INFO] [1538884995.970161, 67.552000]: object num : 2
[INFO] [1538884996.115308, 67.653000]: object num : 2
[INFO] [1538884996.115762, 67.653000]: object num : 2
[INFO] [1538884996.237558, 67.749000]: object num : 2
[INFO] [1538884996.237980, 67.749000]: object num : 2
[ INFO] [1538884996.255804891, 67.759000000]: computeCenterAndBoundingBox1
[ INFO] [1538884996.255883762, 67.759000000]: computeCenterAndBoundingBox7
[ INFO] [1538884996.255907120, 67.759000000]: computeCenterAndBoundingBox9
[ INFO] [1538884996.256167534, 67.759000000]: computeCenterAndBoundingBox1
[ INFO] [1538884996.256211681, 67.759000000]: computeCenterAndBoundingBox7
[ INFO] [1538884996.256247116, 67.759000000]: computeCenterAndBoundingBox9
[INFO] [1538884996.372057, 67.849000]: object num : 2
[INFO] [1538884996.372494, 67.849000]: object num : 2
[INFO] [1538884996.504819, 67.949000]: object num : 2
[INFO] [1538884996.505349, 67.950000]: object num : 2
[INFO] [1538884996.642181, 68.049000]: object num : 2
[INFO] [1538884996.642588, 68.049000]: object num : 2
[INFO] [1538884996.780846, 68.149000]: object num : 2
[INFO] [1538884996.781398, 68.150000]: object num : 2
[INFO] [1538884996.927017, 68.250000]: object num : 2
[INFO] [1538884996.927367, 68.250000]: object num : 2
[ INFO] [1538884996.966036727, 68.268000000]: computeCenterAndBoundingBox1
[ INFO] [1538884996.966090618, 68.268000000]: computeCenterAndBoundingBox7
[ INFO] [1538884996.966112464, 68.268000000]: computeCenterAndBoundingBox9
[ INFO] [1538884996.966305752, 68.268000000]: computeCenterAndBoundingBox1
[ INFO] [1538884996.966328193, 68.268000000]: computeCenterAndBoundingBox7
[ INFO] [1538884996.966355984, 68.268000000]: computeCenterAndBoundingBox9
[ INFO] [1538884996.966452151, 68.268000000]: computeCenterAndBoundingBox1
[ INFO] [1538884996.966472650, 68.268000000]: computeCenterAndBoundingBox7
[ INFO] [1538884996.966490786, 68.268000000]: computeCenterAndBoundingBox9
[INFO] [1538884997.084164, 68.349000]: object num : 3
[INFO] [1538884997.084544, 68.349000]: object num : 3
[INFO] [1538884997.084835, 68.349000]: object num : 3
[INFO] [1538884997.204453, 68.449000]: object num : 3
[INFO] [1538884997.204856, 68.449000]: object num : 3
[INFO] [1538884997.205178, 68.449000]: object num : 3
	
	
	
bool ClusterPointIndicesDecomposer::computeCenterAndBoundingBox
  (const pcl::PointCloud<pcl::PointXYZRGB>::Ptr segmented_cloud,
   const std_msgs::Header header,
   const jsk_recognition_msgs::PolygonArrayConstPtr& planes,
   const jsk_recognition_msgs::ModelCoefficientsArrayConstPtr& coefficients,
   geometry_msgs::Pose& center_pose_msg,
   jsk_recognition_msgs::BoundingBox& bounding_box)
  {
    bounding_box.header = header;

    bool is_center_valid = false;
    Eigen::Vector4f center;
    pcl::PointCloud<pcl::PointXYZRGB>::Ptr
      segmented_cloud_transformed (new pcl::PointCloud<pcl::PointXYZRGB>);
    // align boxes if possible
    Eigen::Matrix4f m4 = Eigen::Matrix4f::Identity();
    Eigen::Quaternionf q = Eigen::Quaternionf::Identity();

    NODELET_INFO("computeCenterAndBoundingBox1");
    if (align_boxes_) {
      NODELET_INFO("computeCenterAndBoundingBox2");
      if (align_boxes_with_plane_) {
        NODELET_INFO("computeCenterAndBoundingBox3");
        is_center_valid = pcl::compute3DCentroid(*segmented_cloud, center) != 0;
        bool success = transformPointCloudToAlignWithPlane(segmented_cloud, segmented_cloud_transformed,
                                                           center, planes, coefficients, m4, q);
        if (!success) {
          return false;
        }
      }
      else {
        // transform point cloud to target frame
        tf::StampedTransform tf_transform;
	NODELET_INFO("computeCenterAndBoundingBox4");
        try {
          tf_transform = jsk_recognition_utils::lookupTransformWithDuration(
            /*listener=*/tf_listener_,
            /*to_frame=*/header.frame_id,                // box origin
            /*from_frame=*/target_frame_id_,  // sensor origin
            /*time=*/header.stamp,
            /*duration=*/ros::Duration(1.0));
        }
        catch (tf2::TransformException &e) {
          NODELET_ERROR("Transform error: %s", e.what());
          return false;
        }
        Eigen::Affine3f transform;
        tf::transformTFToEigen(tf_transform, transform);
        pcl::transformPointCloud(*segmented_cloud, *segmented_cloud, transform);

        is_center_valid = pcl::compute3DCentroid(*segmented_cloud, center) != 0;

        // compute planes from target frame
        pcl::PointXYZRGB min_pt, max_pt;
        pcl::getMinMax3D(*segmented_cloud, min_pt, max_pt);
        //
        pcl_msgs::ModelCoefficients coef_by_frame;
        coef_by_frame.values.push_back(0);
        coef_by_frame.values.push_back(0);
        coef_by_frame.values.push_back(1);
        coef_by_frame.values.push_back(- min_pt.z);
        jsk_recognition_msgs::ModelCoefficientsArray::Ptr coefficients_by_frame(
          new jsk_recognition_msgs::ModelCoefficientsArray);
        coefficients_by_frame->header.frame_id = target_frame_id_;
        coefficients_by_frame->coefficients.push_back(coef_by_frame);
        //
        geometry_msgs::PolygonStamped plane_by_frame;
        plane_by_frame.header.frame_id = target_frame_id_;
        geometry_msgs::Point32 point;
        point.z = min_pt.z;
        point.x = min_pt.x;
        point.y = min_pt.y;
        plane_by_frame.polygon.points.push_back(point);
        point.x = max_pt.x;
        point.y = min_pt.y;
        plane_by_frame.polygon.points.push_back(point);
        point.x = max_pt.x;
        point.y = max_pt.y;
        plane_by_frame.polygon.points.push_back(point);
        point.x = min_pt.x;
        point.y = max_pt.y;
        plane_by_frame.polygon.points.push_back(point);
        jsk_recognition_msgs::PolygonArray::Ptr planes_by_frame(
          new jsk_recognition_msgs::PolygonArray);
        planes_by_frame->header.frame_id = target_frame_id_;
        planes_by_frame->polygons.push_back(plane_by_frame);
        //
        bool success = transformPointCloudToAlignWithPlane(segmented_cloud, segmented_cloud_transformed,
                                                           center, planes_by_frame, coefficients_by_frame, m4, q);
        NODELET_INFO("computeCenterAndBoundingBox5");
        if (!success) {
	  NODELET_INFO("computeCenterAndBoundingBox6");
          return false;
        }
      }
    }
    else {
      NODELET_INFO("computeCenterAndBoundingBox7");
      segmented_cloud_transformed = segmented_cloud;
      is_center_valid = pcl::compute3DCentroid(*segmented_cloud_transformed, center) != 0;
    }
      
    // create a bounding box
    Eigen::Vector4f minpt, maxpt;
    pcl::getMinMax3D<pcl::PointXYZRGB>(*segmented_cloud_transformed, minpt, maxpt);

    double xwidth = maxpt[0] - minpt[0];
    double ywidth = maxpt[1] - minpt[1];
    double zwidth = maxpt[2] - minpt[2];
    if (!pcl_isfinite(xwidth) || !pcl_isfinite(ywidth) || !pcl_isfinite(zwidth))
    {
      // all points in cloud are nan or its size is 0
      xwidth = ywidth = zwidth = 0;
    }
    
    Eigen::Vector4f center2((maxpt[0] + minpt[0]) / 2.0, (maxpt[1] + minpt[1]) / 2.0, (maxpt[2] + minpt[2]) / 2.0, 1.0);
    Eigen::Vector4f center_transformed = m4 * center2;
      
    // set centroid pose msg
    if (is_center_valid) {
      NODELET_INFO("computeCenterAndBoundingBox8");
      center_pose_msg.position.x = center[0];
      center_pose_msg.position.y = center[1];
      center_pose_msg.position.z = center[2];
      center_pose_msg.orientation.x = 0;
      center_pose_msg.orientation.y = 0;
      center_pose_msg.orientation.z = 0;
      center_pose_msg.orientation.w = 1;
    }
    else {
      // set invalid pose for invalid center
      NODELET_INFO("computeCenterAndBoundingBox9");
      center_pose_msg = geometry_msgs::Pose();
    }
    
    // set bounding_box msg
    bounding_box.pose.position.x = center_transformed[0];
    bounding_box.pose.position.y = center_transformed[1];
    bounding_box.pose.position.z = center_transformed[2];
    bounding_box.pose.orientation.x = q.x();
    bounding_box.pose.orientation.y = q.y();
    bounding_box.pose.orientation.z = q.z();
    bounding_box.pose.orientation.w = q.w();
    bounding_box.dimensions.x = xwidth;
    bounding_box.dimensions.y = ywidth;
    bounding_box.dimensions.z = zwidth;
    return true;
  }
